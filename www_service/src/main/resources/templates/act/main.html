<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8">
<title>ì²´í—˜ í™œë™ ì •ë³´</title>
<script src="https://code.jquery.com/jquery-3.7.1.js"
	integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
	crossorigin="anonymous"></script>
<style>
table {
    font-size: 12px;
    border-collapse: collapse;
    margin: 30px auto;
    width: 1200px;
    max-width: 1200px;
    border: 1px solid #ddd;
}

table th, table td {
    padding: 20px 20px;
    border: 1px solid #ddd;
    text-align: center;
}

table th {
    background-color: #f8f8f8;
    font-weight: bold;
    font-size: 15px;
}
table td {
	font-size: 16px;
}

table tr.clickable:hover {
    background-color: #f1f1f1;
    cursor: pointer;
}

/* ê²€ìƒ‰ ìƒì ìŠ¤íƒ€ì¼ */
.search-container {
    margin: 20px auto;
    text-align: center;
}

#search-box {
    width: 360px;
    height: 45px;
    padding: 5px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
}

#search-button {
    height: 40px;
    padding: 0 20px;
    font-size: 14px;
    border: 1px solid #007bff;
    background-color: #007bff;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 10px;
}

#search-button:hover {
    background-color: #0056b3;
}

/* ì§€ë„ ì˜ì—­ ìŠ¤íƒ€ì¼ */
#map {
    margin: 50px auto;
    width: 1000px;
    max-width: 1000px;
    height: 500px;
    border: 1px solid #ddd;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
.pagination {
    text-align: center;
    margin: 20px auto;
}

.pagination button {
    padding: 8px 16px;
    margin: 0 5px;
    font-size: 14px;
    border: 1px solid #ccc;
    background-color: #fff;
    color: #333;
    border-radius: 4px;
    cursor: pointer;
}

.pagination button:hover {
    background-color: #f2f2f2;
}

.pagination span {
    font-size: 14px;
    padding: 8px 16px;
}

/* íŒì—… ì •ë³´ì°½ ìŠ¤íƒ€ì¼ */
.wrap {
    width: 200px;
    height: auto;
}

.title {
    padding: 10px;
    background-color: #eee;
    border-bottom: 1px solid #ddd;
    font-size: 16px;
    font-weight: bold;
}

.desc {
    padding: 10px;
}

.desc .actadress,
.desc .tel,
.desc .homeurl {
    margin-bottom: 7px;
    font-size: 14px;
}
.homeurl {
	border-bottom: 1px solid #ccc;
}

.desc .homeurl a {
    color: #007bff;
    text-decoration: none;
}

.desc .homeurl a:hover {
    text-decoration: underline;
}
.w {
    width: 60px;
}
#find{
	font-size: 35px;
	text-align: center;
	font-weight: bold;
}


</style>
</head>

<body>
	<header>
		<th:block th:insert="~{/sub/header.html}"></th:block>
	</header>

	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9dc3cd9f3f49ffc9bf97e4d73894b388&libraries=services,clusterer,drawing"></script>
	<section>
		<div id="find"> ğŸ” ìì—° ì²´í—˜ í”„ë¡œê·¸ë¨ íœ´ì–‘ë§ˆì„ ì°¾ê¸° </div>
		<div id="map"></div>

		<div class="search-container">
			<input type="text" id="search-box" class="search-box"
				placeholder="ì‹œë„ëª… or ì‹œêµ°êµ¬ëª… or ì²´í—˜ë§ˆì„ or ì²´í—˜ë‚´ìš© ì…ë ¥í•˜ì„¸ìš”.">
			<button id="search-button" class="search-button">ê²€ìƒ‰</button>
		</div>

		<table border="1">
			<thead>
				<tr>
					<th class="w">ë²ˆí˜¸</th>
					<th>ì²´í—˜ë§ˆì„ëª…</th>
					<th>ì‹œë„ëª…</th>
					<th class="w">ì‹œêµ°êµ¬ëª…</th>
					<th>ì²´í—˜í”„ë¡œê·¸ë¨</th>
					<th>ì£¼ì†Œ</th>
					<th>ê¸°ê´€ëª…</th>
				</tr>
			</thead>
			<tbody>
				<!-- í…Œì´ë¸” -->
			</tbody>
		</table>

		<div class="pagination">
			<button id="prev-page">ì´ì „</button>
			<span id="current-page">1</span>
			<button id="next-page">ë‹¤ìŒ</button>
		</div>
	</section>

	<footer>
		<th:block th:insert="~{/sub/footer.html}"></th:block>
	</footer>

	<script>
	
	var map;
	var marker;
	var container;
	var options;
	var markerPosition;
	
	function initMap() {
		//ì´ˆê¸°ì§€ë„ì„¤ì •
		container = document.getElementById('map');
	    options = {
	    	center: new kakao.maps.LatLng(37.5665, 126.9780), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
	        level: 3
	    };
	    map = new kakao.maps.Map(container, options); //ì§€ë„ìƒì„± 
	    
		// ë§ˆì»¤ê°€ í‘œì‹œë  ìœ„ì¹˜ì…ë‹ˆë‹¤ 
	    markerPosition  = new kakao.maps.LatLng(37.5665, 126.9780); 
	    
	 	// ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
	    marker = new kakao.maps.Marker({
	        position: markerPosition,
	        map: map //ë§ˆì»¤ë¥¼ ì´ˆê¸°ì§€ë„ì— í‘œì‹œ 
	    });
	 	
	 	// ë§ˆì»¤ê°€ ì§€ë„ ìœ„ì— í‘œì‹œë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤
	    //marker.setMap(map);
	}
	
	function updateMap(lat, lng, vname, homeurl, actadress, tel) {
		//ë§ˆì»¤ ìœ„ì¹˜ ì´ë™ 
		container = document.getElementById('map');
		options = {
		    	center: new kakao.maps.LatLng(lat, lng), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
		        level: 3
		    };
		map = new kakao.maps.Map(container, options); // í´ë¦­í•œ ì§€ì—­ ì§€ë„ ì´ë™ 
		
		markerPosition = new kakao.maps.LatLng(lat, lng); //ë§ˆì»¤ìƒì„±
		
		marker = new kakao.maps.Marker({   //í´ë¦­í•œ ì§€ì—­ìœ¼ë¡œ ë§ˆì»¤ ì´ë™
			position: markerPosition,
			map: map
		});
		
		console.log(lat, lng);
		console.log(map, markerPosition);
		console.log(vname, homeurl, actadress, tel);
		
		//ì¢Œí‘œê°’ì´ NaNì¸ì§€ í™•ì¸ 
		if (isNaN(lat) || isNaN(lng)) {
		    console.error('Invalid coordinates:', lat, lng);
		    return;
		}
		
		// ë³€ìˆ˜ê°’ì´ undefinedë‚˜ nullì¸ ê²½ìš° ë¹ˆ ë¬¸ìì—´ë¡œ ì„¤ì •
	    vname = vname || '';
	    homeurl = homeurl || '#';
	    actadress = actadress || '';
	    tel = tel || '';
		
		var content = 
			'<div class="wrap">' + 
				'<div class="info">' + 
					'<div class="title">' + vname + '</div>' +  
				'</div>' + 	
				'<div class="desc">' + 
					'<div class="actadress">' + actadress + '</div>' +
					'<div class="tel">' + tel + '</div>' + 
					'<div><a href="'+homeurl+'" class="homeurl" target="_blank">' + 'í™ˆí˜ì´ì§€ ê°€ê¸°' + '</a></div>' +
				'</div>' + 	
			+ '</div>'	
	
		var infowindow = new kakao.maps.InfoWindow({
			content: content,
			map: map,
			position: markerPosition 
		});
		
		infowindow.open(map, marker);
	}
 	
 	//í˜ì´ì§€ë„¤ì´ì…˜
    let currentPage = 1;
    const itemsPerPage = 20; // í•œ í˜ì´ì§€ì— í‘œì‹œí•  í•­ëª© ìˆ˜
    
 	//ì²´í—˜ë§ˆì„ ì „ì²´ ë¦¬ìŠ¤íŠ¸ 
	$(document).ready(function() {
		initMap(); //ì§€ë„ì´ˆê¸°í™”
		
    	//ê²€ìƒ‰
    	$("#search-button").on("click", function() {
            const searchQuery = $("#search-box").val().trim();
            console.log(searchQuery);
            if (!searchQuery) {
                alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
                return;
            }
            searchList(searchQuery);
        });
    	
    // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
    $('#prev-page').on('click', function() {
        if (currentPage > 1) {
            currentPage--;
            loadPage(currentPage);
        }
    });

    $('#next-page').on('click', function() {
        currentPage++;
        loadPage(currentPage);
    });

    loadPage(currentPage); // ì²« í˜ì´ì§€ ë¡œë“œ
    
    //tr í´ë¦­ì‹œ í•´ë‹¹ ì¢Œí‘œ ê°€ì ¸ì™€ì„œ ì§€ë„ì— í‘œì‹œ 
    $(document).on("click", ".clickable", function() {
    	var locationx = $(this).data("locationx");
        var locationy = $(this).data("locationy");
        var vname = $(this).data("vname");
        var homeurl = $(this).data("homeurl");
        var actadress = $(this).data("actadress");
        var tel = $(this).data("tel");
        
        console.log("Original data-locationx:", locationx);
        console.log("Original data-locationy:", locationy);
        console.log("vaname:", vname);
        console.log("homeurl:", homeurl);
        console.log("actadress:", actadress);
        console.log("tel:", tel);
        
     	// ì¢Œí‘œë¥¼ ìˆ«ìë¡œ ë³€í™˜
        locationx = parseFloat(locationx);
        locationy = parseFloat(locationy);
        
        // ë³€í™˜ëœ ì¢Œí‘œë¥¼ ì½˜ì†”ì— ì¶œë ¥
        console.log("Parsed locationx:", locationx);
        console.log("Parsed locationy:", locationy);
        
     	// ì¢Œí‘œê°€ ìœ íš¨í•œ ê²½ìš° ì¶”ê°€ ì‘ì—… ìˆ˜í–‰
        if (!isNaN(locationx) && !isNaN(locationy)) {
            // ì˜ˆ: ì§€ë„ì— ë§ˆì»¤ë¥¼ í‘œì‹œí•˜ê±°ë‚˜ ì§€ë„ ì¤‘ì‹¬ ì´ë™
            // updateMap ë˜ëŠ” ë‹¤ë¥¸ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì—… ìˆ˜í–‰
            updateMap(locationx, locationy, vname, homeurl, actadress, tel);
     		window.location.href = "#map";
        } else {
            console.error("Invalid coordinates:", locationx, locationy);
            alert("ìœ íš¨í•˜ì§€ ì•Šì€ ì¢Œí‘œì…ë‹ˆë‹¤.");
        }
     	
    });
});

	function loadPage(page) {
    	$.ajax({
        	url: "/act/getActiveList",
        	method: "GET",
        	data: {
            	page: page,
            	itemsPerPage: itemsPerPage
        	},
        	success: function(data) {
            	updateTable(data);
            	$('#current-page').text(page);
        	},
        	error: function(error) {
            	console.log("Error:", error);
        	}
    	});
	}
	
	function searchList(query) {
	    $.ajax({
	        url: "/act/searchList",
	        method: "GET",
	        data: {
	            query: query
	        },
	        success: function(data) {
	            updateTable(data);
	            console.log(data);
	            
	        },
	        error: function(error) {
	            console.log("Error:", error);
	        }
	    });
	}
	
function updateTable(data) {
    const tbody = $("tbody");
    tbody.empty();
    data.slice(1).forEach((act, index) => {
        tbody.append(
            "<tr class='clickable' data-locationx='" + act.locationx + "' data-locationy='" + act.locationy + "' data-homeurl='"+ act.homeurl +"' data-vname='"+act.vname+"' data-actadress='"+act.actadress+"' data-tel='"+act.tel+"'>" +
                "<td>" + (index + 1) + "</td>" +
                "<td>" + act.vname + "</td>" +
                "<td>" + act.sido + "</td>" +
                "<td>" + act.sgg + "</td>" +
                "<td>" + act.acttype + "</td>" +
                "<td>" + act.actadress + "</td>" +
                "<td>" + act.agencyname + "</td>" +
            "</tr>"
        );
    });
}

    </script>
</body>

</html>